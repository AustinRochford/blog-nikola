<meta name="title" content="A Bayesian Alternative to Synthetic Control Comparative Case Studies in Python with PyMC3" />
<meta name="tags" content="PyMC3, Causal Inference, Bayesian Statistics, Python" />
<meta name="date" content="2021-08-08" />
<meta name="has_math" content="true" /><p>Recently I had cause to be perusing <a href="https://yiqingxu.org/research/">Yiqing Xu’s research</a> and dove deep into the 2020 paper <em>A Bayesian Alternative to Synthetic Control for Comparative Case Studies</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> (BASC-CCS from now on). In an effort to better understand the method introduced in this paper, I decided to replicate (most of) the results form the simulation study described in Sections 4.1 and A.4.1 in Python using PyMC3.</p>
<p>BASC-CCS uses <a href="https://en.wikipedia.org/wiki/Cross-sectional_data">time series cross sectional data</a> (TSCS) to infer causal effects from observational data where direct control of the treatment mechanism is not possible. As such it falls under the umbrella of <a href="https://en.wikipedia.org/wiki/Causal_inference">causal inference methods</a>. More specifically, it uses the Bayesian approach that treats causal inference from observational data as a problem of imputing missing (control) data for treated units.</p>
<h2 id="generate-the-data">Generate the Data</h2>
<p>We begin by generating the data to be modeled. First we make the necessary Python imports and do some light housekeeping.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> warnings <span class="im">import</span> filterwarnings</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> aesara <span class="im">import</span> tensor <span class="im">as</span> at</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.lines <span class="im">import</span> Line2D</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc3 <span class="im">as</span> pm</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy <span class="im">as</span> sp</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span></code></pre></div>
<pre><code>You are running the v4 development version of PyMC3 which currently still lacks key features. You probably want to use the stable v3 instead which you can either install via conda or find on the v3 GitHub branch: https://github.com/pymc-devs/pymc3/tree/v3</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>filterwarnings(<span class="st">&#39;ignore&#39;</span>, category<span class="op">=</span>pm.ImputationWarning, module<span class="op">=</span><span class="st">&#39;pymc3&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">&#39;figure.figsize&#39;</span>] <span class="op">=</span> (<span class="dv">8</span>, <span class="dv">6</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>(color_codes<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<p>BASC-CCS is designed for TSCS where a number of units are observed over a period of time. Following the BASC-CCS paper, we simulate data from <span class="math inline">\(N = 50\)</span> units over <span class="math inline">\(T = 30\)</span> time periods.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> np.arange(T)</span></code></pre></div>
<p>In this simulation 10% of the units will be treated starting at time <span class="math inline">\(T_{\mathrm{treat}} = 21\)</span>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>T_treat <span class="op">=</span> <span class="dv">21</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>P_treat <span class="op">=</span> <span class="fl">0.1</span></span></code></pre></div>
<p>Which units are treated will be determined by a linear combination of two unobserved latent factors, drawn from a standard normal distribution for each unit, <span class="math inline">\(\Gamma_{i, 1}, \Gamma_{i, 2} \sim N(0, 1)\)</span> (note that we use capital letters for simulated quantities and the corresponding lowercase letters for the corresponding inferred parameters).</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">12345</span> <span class="co"># for reproducibility</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(SEED)</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>Γ <span class="op">=</span> rng.normal(size<span class="op">=</span>(N, <span class="dv">2</span>))</span></code></pre></div>
<p>Treatment is determined according to the variable</p>
<p><span class="math display">\[\mathrm{tr}_i = 0.7 \cdot \Gamma_{i, 1} + 0.3 \cdot \Gamma_{i, 2} + \varepsilon^{\Gamma}_i,\]</span></p>
<p>where <span class="math inline">\(\varepsilon^{\Gamma}_i \sim N(0, 0.25).\)</span></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> Γ.dot([<span class="fl">0.7</span>, <span class="fl">0.3</span>]) <span class="op">+</span> rng.normal(<span class="fl">0.</span>, <span class="fl">0.5</span>, size<span class="op">=</span>N)</span></code></pre></div>
<p>The five units with the largest values of <span class="math inline">\(tr_i\)</span> are treated.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>treat_crit <span class="op">=</span> np.percentile(tr, <span class="dv">100</span> <span class="op">*</span> (<span class="fl">1.</span> <span class="op">-</span> P_treat))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>treated <span class="op">=</span> tr <span class="op">&gt;</span> treat_crit</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>n_treated <span class="op">=</span> treated.<span class="bu">sum</span>()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>n_treated</span></code></pre></div>
<pre><code>5</code></pre>
<p>The following plot shows the relationship between the latent values <span class="math inline">\(\Gamma_i\)</span> and which units are treated.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>CMAP <span class="op">=</span> <span class="st">&#39;winter&#39;</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">&#39;equal&#39;</span>)<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>norm <span class="op">=</span> plt.Normalize(tr.<span class="bu">min</span>(), tr.<span class="bu">max</span>())</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span>Γ[<span class="op">~</span>treated, <span class="dv">0</span>], y<span class="op">=</span>Γ[<span class="op">~</span>treated, <span class="dv">1</span>], hue<span class="op">=</span>tr[<span class="op">~</span>treated],</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                hue_norm<span class="op">=</span>norm, palette<span class="op">=</span>CMAP,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">&quot;Untreated&quot;</span>, legend<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax)<span class="op">;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span>Γ[treated, <span class="dv">0</span>], y<span class="op">=</span>Γ[treated, <span class="dv">1</span>], hue<span class="op">=</span>tr[treated],</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                s<span class="op">=</span><span class="dv">100</span>, marker<span class="op">=</span><span class="st">&#39;s&#39;</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                hue_norm<span class="op">=</span>norm, palette<span class="op">=</span>CMAP,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">&quot;Treated&quot;</span>, legend<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax)<span class="op">;</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>Γ_mult <span class="op">=</span> <span class="fl">1.05</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>Γ_min, Γ_max <span class="op">=</span> Γ_mult <span class="op">*</span> Γ.<span class="bu">min</span>(), Γ_mult <span class="op">*</span> Γ.<span class="bu">max</span>()</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>plot_Γ <span class="op">=</span> np.linspace(Γ_min, Γ_max, <span class="dv">100</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>ax.plot(plot_Γ, (treat_crit <span class="op">-</span> <span class="fl">0.7</span> <span class="op">*</span> plot_Γ) <span class="op">/</span> <span class="fl">0.3</span>,</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">&#39;k&#39;</span>, ls<span class="op">=</span><span class="st">&#39;--&#39;</span>, label<span class="op">=</span><span class="st">&quot;Treatment threshold</span><span class="ch">\n</span><span class="st">(noiseless)&quot;</span>)<span class="op">;</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>sm <span class="op">=</span> plt.cm.ScalarMappable(norm<span class="op">=</span>norm, cmap<span class="op">=</span>CMAP)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> fig.colorbar(sm)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(Γ_min, Γ_max)<span class="op">;</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="vs">r&quot;$\Gamma_{i, 1}$&quot;</span>)<span class="op">;</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(Γ_min, Γ_max)<span class="op">;</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r&quot;$\Gamma_{i, 2}$&quot;</span>)<span class="op">;</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>cbar.set_label(<span class="vs">r&quot;$\mathrm</span><span class="sc">{tr}</span><span class="vs">_i$&quot;</span>)<span class="op">;</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">&#39;upper left&#39;</span>)<span class="op">;</span></span></code></pre></div>
<center>
<img src="/resources/basc-ccs_files/basc-ccs_22_0.png" title="fig:" alt="png" />
</center>
<p>The inclusion of the noise term <span class="math inline">\(\varepsilon^{\Gamma}_i\)</span> causes some of the treated units to be below the treatment threshold line in this plot and some of the points above the treatment threshold line to not be treated.</p>
<p>We now generate <span class="math inline">\(K = 10\)</span> covariates for each unit, one of which is a constant intercept and the rest of which follow a standard normal distribution.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> <span class="dv">10</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.empty((N, K))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>X[:, <span class="dv">0</span>] <span class="op">=</span> <span class="fl">1.</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>X[:, <span class="dv">1</span>:] <span class="op">=</span> rng.normal(size<span class="op">=</span>(N, K <span class="op">-</span> <span class="dv">1</span>))</span></code></pre></div>
<p>Following the paper, the first <span class="math inline">\(K_* = 4\)</span> covariates influence the outcome, and the rest are uncorrelated with it. The true regression coefficients, <span class="math inline">\(B_j\)</span> are taken from the BASC-CCS paper.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>K_star <span class="op">=</span> <span class="dv">4</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> np.zeros(K)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>B[:K_star] <span class="op">=</span> <span class="fl">3.</span>, <span class="fl">6.</span>, <span class="fl">4.</span>, <span class="fl">2.</span></span></code></pre></div>
<p>The influence of each of the first <span class="math inline">\(K_*\)</span> covariates varies by unit, according to <span class="math inline">\(A_{i, j} \sim N\left(0, \left(\frac{B_j}{2}\right)^2\right)\)</span>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> np.zeros((N, K))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>A[:, :K_star] <span class="op">=</span> rng.normal(<span class="fl">0.</span>, <span class="fl">0.5</span> <span class="op">*</span> B[:K_star], size<span class="op">=</span>(N, K_star))</span></code></pre></div>
<p>The influence of these first <span class="math inline">\(K_*\)</span> covariates also varies over time according to an <span class="math inline">\(AR(1)\)</span> process <span class="math inline">\(\Xi_{j, t}\)</span> with autocorrelation of <span class="math inline">\(0.6\)</span> and standard normal innovations.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ar1(k, innov):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> np.arange(innov.shape[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    expon <span class="op">=</span> sp.linalg.toeplitz(t)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.dot(innov, np.triu(np.power(k, expon)))</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>innov_Ξ <span class="op">=</span> rng.normal(size<span class="op">=</span>(K_star, T))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>Ξ <span class="op">=</span> np.zeros((K, T))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>Ξ[:K_star] <span class="op">=</span> ar1(<span class="fl">0.6</span>, innov_Ξ)</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>ax.plot(t, Ξ.T, c<span class="op">=</span><span class="st">&#39;k&#39;</span>, alpha<span class="op">=</span><span class="fl">0.75</span>)<span class="op">;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">&quot;$t$&quot;</span>)<span class="op">;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r&quot;$\Xi_{i, t}$&quot;</span>)<span class="op">;</span></span></code></pre></div>
<center>
<img src="/resources/basc-ccs_files/basc-ccs_34_0.png" title="fig:" alt="png" />
</center>
<p>The horizontal lines at zero here correspond to the <span class="math inline">\(K - K_*\)</span> covariates that have no influence on the outcome and do not vary over time.</p>
<p>The noise in outcomes is related to the latent parameters <span class="math inline">\(\Gamma_i\)</span> through factor loadings <span class="math inline">\(F_t\)</span>, which also follow an <span class="math inline">\(AR(1)\)</span> process with autocorrelation of <span class="math inline">\(0.7\)</span> and standard normal innovations.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>innov_F <span class="op">=</span> rng.normal(size<span class="op">=</span>(<span class="dv">2</span>, T))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>F <span class="op">=</span> ar1(<span class="fl">0.7</span>, innov_F)</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>ax.plot(t, F.T, c<span class="op">=</span><span class="st">&#39;k&#39;</span>, alpha<span class="op">=</span><span class="fl">0.75</span>)<span class="op">;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">&quot;$t$&quot;</span>)<span class="op">;</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r&quot;$F_{i, t}$&quot;</span>)<span class="op">;</span></span></code></pre></div>
<center>
<img src="/resources/basc-ccs_files/basc-ccs_37_0.png" title="fig:" alt="png" />
</center>
<p>Finally, we simulate the treament effects, which are</p>
<p><span class="math display">\[
\Delta_{i, t} =
    \begin{cases}
        t - T_{\mathrm{treat}} + \varepsilon^{\mathrm{treat}}_{i, t} &amp; \mathrm{if}\ t &gt; T_{\mathrm{treat}} \\
        0 &amp; \mathrm{if}\ t \leq T_{\mathrm{treat}}
    \end{cases}
\]</span></p>
<p>where <span class="math inline">\(\varepsilon^{\mathrm{treat}}_{i, t} \sim N(0, 0.25)\)</span>.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>Δ <span class="op">=</span> np.zeros((N, T))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>Δ[:, T_treat:] <span class="op">=</span> t[T_treat:] <span class="op">-</span> T_treat <span class="op">\</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                    <span class="op">+</span> rng.normal(<span class="fl">0.</span>, <span class="fl">0.5</span>, size<span class="op">=</span>(N, T <span class="op">-</span> T_treat))</span></code></pre></div>
<p>The array <code>w</code> indicates which units where treated at a given time, with</p>
<p><span class="math display">\[
w_{i, t} =
    \begin{cases}
        1 &amp; \mathrm{if\ unit}\ i\ \mathrm{is\ treated\ at\ time}\ t \\
        0 &amp; \mathrm{otherwise}
    \end{cases}.
\]</span></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> np.zeros((N, T))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>w[treated, T_treat:] <span class="op">=</span> <span class="dv">1</span></span></code></pre></div>
<p>We plot the treatment effects that our model will attempt to recover.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>ax.plot(t, (Δ <span class="op">*</span> w)[<span class="op">~</span>treated][<span class="dv">0</span>],</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">&#39;k&#39;</span>, label<span class="op">=</span><span class="st">&quot;Untreated&quot;</span>)<span class="op">;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>ax.plot(t, (Δ <span class="op">*</span> w)[treated][<span class="dv">0</span>],</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">&#39;r&#39;</span>, alpha<span class="op">=</span><span class="fl">0.75</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">&quot;Treated&quot;</span>)<span class="op">;</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>ax.plot(t, (Δ <span class="op">*</span> w)[treated][<span class="dv">1</span>:].T,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">&#39;r&#39;</span>, alpha<span class="op">=</span><span class="fl">0.75</span>)<span class="op">;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">&quot;$t$&quot;</span>)<span class="op">;</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r&quot;$\Delta_{i, t} \cdot w_{i, t}$&quot;</span>)<span class="op">;</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">&#39;upper left&#39;</span>)<span class="op">;</span></span></code></pre></div>
<center>
<img src="/resources/basc-ccs_files/basc-ccs_43_0.png" title="fig:" alt="png" />
</center>
<p>We combine each of these components to generate the data to be modeled.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>Θ <span class="op">=</span> (B <span class="op">+</span> A)[..., np.newaxis] <span class="op">+</span> Ξ[np.newaxis]</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>XΘ <span class="op">=</span> (X[..., np.newaxis] <span class="op">*</span> Θ).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div>
<p>We combine the reatment effects, the effects of the covariates, the effects of the latent factors, and standard normal noise to get the observed outcomes, <span class="math inline">\(y_{i, t}\)</span>.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> Δ <span class="op">*</span> w <span class="op">+</span> XΘ <span class="op">+</span> Γ.dot(F) <span class="op">+</span> rng.normal(size<span class="op">=</span>(N, T))</span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>ax.axvline(T_treat, c<span class="op">=</span><span class="st">&#39;k&#39;</span>, ls<span class="op">=</span><span class="st">&#39;--&#39;</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>           label<span class="op">=</span><span class="st">&quot;$T_{\mathrm</span><span class="sc">{treat}</span><span class="st">}$&quot;</span>)<span class="op">;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>ax.plot(t, y[<span class="op">~</span>treated].T, c<span class="op">=</span><span class="st">&#39;k&#39;</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)<span class="op">;</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>ax.plot([], [], c<span class="op">=</span><span class="st">&#39;k&#39;</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">&quot;Untreated&quot;</span>)<span class="op">;</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>ax.plot(t, y[treated].T, c<span class="op">=</span><span class="st">&#39;r&#39;</span>, lw<span class="op">=</span><span class="dv">3</span>, alpha<span class="op">=</span><span class="fl">0.75</span>)<span class="op">;</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>ax.plot([], [], c<span class="op">=</span><span class="st">&#39;r&#39;</span>, alpha<span class="op">=</span><span class="fl">0.75</span>,</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">&quot;Treated&quot;</span>)<span class="op">;</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">&quot;$t$&quot;</span>)<span class="op">;</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">&quot;$y_{i, t}$&quot;</span>)<span class="op">;</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">&quot;upper left&quot;</span>)<span class="op">;</span></span></code></pre></div>
<center>
<img src="/resources/basc-ccs_files/basc-ccs_48_0.png" title="fig:" alt="png" />
</center>
<p>We see that the treated units have outcomes that generally trend up after <span class="math inline">\(T_{\mathrm{treat}}\)</span>, but there is a lot of visual noise to interpret when comparing those to the untreated units. Thee BASC-CCS model w will build in the next section will help to quantify the difference and cut through this noise.</p>
<h2 id="modeling">Modeling</h2>
<h3 id="unidentified-latent-factors">Unidentified latent factors</h3>
<p>We begin with a model that has <a href="https://en.wikipedia.org/wiki/Identifiability#:~:text=In%20statistics%2C%20identifiability%20is%20a,number%20of%20observations%20from%20it.">unidentified</a> latent factors in order to determine which factors we should constrain to best identify our model. For more details about implementing factor analysis models in PyMC see my <a href="https://austinrochford.com/posts/2021-07-05-factor-analysis-pymc3.html">previous post</a> on the topic.</p>
<p>Since we are using the Bayesian causal-inference-as-missing-data paradigm, we define the control observations as a <a href="https://numpy.org/doc/stable/reference/maskedarray.html">masked array</a>, with entries masked when <span class="math inline">\(w_{i, t} = 1\)</span>, indicating that the <span class="math inline">\(i\)</span>-th unit was treated at time <span class="math inline">\(t\)</span>.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>y_ctrl <span class="op">=</span> np.ma.array(y, mask<span class="op">=</span>w)</span></code></pre></div>
<p>For simplicity our model will use two latent factors, even though in general we do not know the true number of latent factors. For a more rigorous discussion of how to choose the number of latent factors, see <a href="https://probml.github.io/pml-book/"><em>Machine Learning, A Probabilistic Perspective</em></a><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, §12.3.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>N_factor <span class="op">=</span> <span class="dv">2</span></span></code></pre></div>
<p>We define the coordinates for our parameters. (For more information on how to get PyMC3 to interact nicely with <a href="http://xarray.pydata.org/en/stable/index.html"><code>xarray</code></a> via coordinates, see Oriol Abril’s excellent <a href="https://oriolabril.github.io/oriol_unraveled/python/arviz/pymc3/xarray/2020/09/22/pymc3-arviz.html">post</a> on the subject.)</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>coords <span class="op">=</span> {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;unit&quot;</span>: np.arange(N),                        <span class="co"># units</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;fact&quot;</span>: np.arange(N_factor),                 <span class="co"># latent factors</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;feat&quot;</span>: np.arange(K),                        <span class="co"># features</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;time&quot;</span>: t,                                   <span class="co"># time</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;time_block&quot;</span>: np.arange(T <span class="op">-</span> (N_factor <span class="op">+</span> <span class="dv">1</span>))  <span class="co"># block of time for identifying factors</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We put centered normal priors on our shared regression coefficients, <span class="math inline">\(\beta_j\)</span>. This prior differs from the one in the paper, which uses a <a href="https://austinrochford.com/posts/2021-05-29-horseshoe-pymc3.html">sparse prior</a> for these coefficients. Fortunately since we are using a modular probabilistic programming library, this prior can be changed relatively easily.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>coords) <span class="im">as</span> ref_model:</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    β <span class="op">=</span> pm.Normal(<span class="st">&quot;β&quot;</span>, <span class="fl">0.</span>, <span class="fl">5.</span>, dims<span class="op">=</span><span class="st">&quot;feat&quot;</span>)</span></code></pre></div>
<p>We put <a href="https://twiecki.io/blog/2017/02/08/bayesian-hierchical-non-centered/">hierarchical normally distributed priors</a> with mean zero (for identifiability) on the per-unit random effects <span class="math inline">\(\alpha_{i, j}\)</span> and the per-time random effects <span class="math inline">\(\xi_{j, t}\)</span>.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the scale necessary to make a halfnormal distribution</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># have unit variance</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>HALFNORMAL_SCALE <span class="op">=</span> <span class="fl">1.</span> <span class="op">/</span> np.sqrt(<span class="fl">1.</span> <span class="op">-</span> <span class="fl">2.</span> <span class="op">/</span> np.pi)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> noncentered_normal(name, dims, μ<span class="op">=</span><span class="va">None</span>,):</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> μ <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        μ <span class="op">=</span> pm.Normal(<span class="ss">f&quot;μ_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">&quot;</span>, <span class="fl">0.</span>, <span class="fl">5.</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    Δ <span class="op">=</span> pm.Normal(<span class="ss">f&quot;Δ_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">&quot;</span>, <span class="fl">0.</span>, <span class="fl">1.</span>, dims<span class="op">=</span>dims)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    σ <span class="op">=</span> pm.HalfNormal(<span class="ss">f&quot;σ_</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">&quot;</span>, <span class="fl">5.</span> <span class="op">*</span> HALFNORMAL_SCALE)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pm.Deterministic(name, μ <span class="op">+</span> Δ <span class="op">*</span> σ)</span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> ref_model:</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    α <span class="op">=</span> noncentered_normal(<span class="st">&quot;α&quot;</span>, (<span class="st">&quot;unit&quot;</span>, <span class="st">&quot;feat&quot;</span>), μ<span class="op">=</span><span class="fl">0.</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    ξ <span class="op">=</span> noncentered_normal(<span class="st">&quot;ξ&quot;</span>, (<span class="st">&quot;feat&quot;</span>, <span class="st">&quot;time&quot;</span>), μ<span class="op">=</span><span class="fl">0.</span>)</span></code></pre></div>
<p>Note that here we do not use the fact that the true values of <span class="math inline">\(\Xi_{j, t}\)</span> form an AR(1) process.</p>
<p>We combine <span class="math inline">\(\beta_j\)</span>, <span class="math inline">\(\alpha_{i, j}\)</span>, and <span class="math inline">\(\xi_{j, t}\)</span> to form the full coefficient cube, <span class="math inline">\(\theta_{i, j, t}\)</span>.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>θ <span class="op">=</span> β[np.newaxis, :, np.newaxis] <span class="op">\</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> α[..., np.newaxis] <span class="op">\</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> ξ[np.newaxis, ...]</span></code></pre></div>
<p>We build latent factor component of the model as in the previous post, knowing that this model specificiation is only identified up to reflections of <code>f_unid</code> and <code>γ_unid</code>.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> ref_model:</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    f_pos_row <span class="op">=</span> pm.HalfNormal(<span class="st">&quot;f_pos_row&quot;</span>, HALFNORMAL_SCALE,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                              dims<span class="op">=</span><span class="st">&quot;fact&quot;</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    f_block_unid <span class="op">=</span> pm.Normal(<span class="st">&quot;f_block_unid&quot;</span>, <span class="fl">0.</span>, <span class="fl">1.</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                             dims<span class="op">=</span>(<span class="st">&quot;time_block&quot;</span>, <span class="st">&quot;fact&quot;</span>))</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    f_unid <span class="op">=</span> at.concatenate((</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        at.eye(N_factor),</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        at.shape_padleft(f_pos_row),</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        f_block_unid</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    γ_unid <span class="op">=</span> pm.Normal(<span class="st">&quot;γ_unid&quot;</span>, <span class="fl">0.</span>, <span class="fl">1.</span>, dims<span class="op">=</span>(<span class="st">&quot;unit&quot;</span>, <span class="st">&quot;fact&quot;</span>))</span></code></pre></div>
<p>Finally, we specify our observational likelihood.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> ref_model:</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    μ_ctrl <span class="op">=</span> (X[..., np.newaxis] <span class="op">*</span> θ).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">+</span> γ_unid.dot(f_unid.T)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    σ <span class="op">=</span> pm.HalfNormal(<span class="st">&quot;σ&quot;</span>, <span class="fl">5.</span> <span class="op">*</span> HALFNORMAL_SCALE)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    obs_ctrl <span class="op">=</span> pm.Normal(<span class="st">&quot;obs_ctrl&quot;</span>, μ_ctrl, σ, observed<span class="op">=</span>y_ctrl)</span></code></pre></div>
<p>We now draw 100 samples from this unidentified model.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>CORES <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>SAMPLE_KWARGS <span class="op">=</span> {</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;cores&quot;</span>: CORES,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;random_seed&quot;</span>: [SEED <span class="op">+</span> i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(CORES)],</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;return_inferencedata&quot;</span>: <span class="va">True</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> ref_model:</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    ref_trace <span class="op">=</span> pm.sample(tune<span class="op">=</span><span class="dv">100</span>, draws<span class="op">=</span><span class="dv">100</span>, <span class="op">**</span>SAMPLE_KWARGS)</span></code></pre></div>
<pre><code>Only 100 samples in chain.
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (3 chains in 3 jobs)
NUTS: [β, Δ_α, σ_α, Δ_ξ, σ_ξ, f_pos_row, f_block_unid, γ_unid, σ, obs_ctrl_missing]</code></pre>
<div>
<style>
/* Turns off some styling */
progress {
/* gets rid of default border in Firefox and Opera. */
border: none;
/* Needs to be in here for Safari polyfill so background images work as expected. */
background-size: auto;
}
.progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
background: #F44336;
}
</style>
<progress value="600" class max="600" style="width:300px; height:20px; vertical-align: middle;">
</progress>
<p>100.00% [600/600 02:14&lt;00:00 Sampling 3 chains, 18 divergences]</p>
</div>
<pre><code>Sampling 3 chains for 100 tune and 100 draw iterations (300 + 300 draws total) took 136 seconds.
There were 18 divergences after tuning. Increase `target_accept` or reparameterize.
The acceptance probability does not match the target. It is 1.0, but should be close to 0.8. Try to increase the number of tuning steps.
The rhat statistic is larger than 1.4 for some parameters. The sampler did not converge.
The number of effective samples is smaller than 10% for some parameters.</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>az.rhat(ref_trace).<span class="bu">max</span>()</span></code></pre></div>
<div>
<svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs> <symbol id="icon-database" viewBox="0 0 32 32"> <path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path> <path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path> <path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path> </symbol> <symbol id="icon-file-text2" viewBox="0 0 32 32"> <path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path> <path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path> <path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path> <path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path> </symbol> </defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style>
<pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
Dimensions:           ()
Data variables:
    β                 float64 1.813
    Δ_α               float64 1.885
    σ_α               float64 1.814
    Δ_ξ               float64 1.86
    σ_ξ               float64 1.805
    f_pos_row         float64 1.727
    f_block_unid      float64 1.818
    γ_unid            float64 1.808
    σ                 float64 1.832
    obs_ctrl_missing  float64 1.82
    α                 float64 1.85
    ξ                 float64 1.848</pre>
<div class="xr-wrap" hidden="">
<div class="xr-header">
<div class="xr-obj-type">
xarray.Dataset
</div>
</div>
<ul class="xr-sections">
<li class="xr-section-item">
<input id='section-893aabd1-b7b6-4733-91c9-282bb59cb3c1' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-893aabd1-b7b6-4733-91c9-282bb59cb3c1' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label>
<div class="xr-section-inline-details">

</div>
<div class="xr-section-details">

</div>
</li>
<li class="xr-section-item">
<input id='section-4b556a2e-1ca2-436c-b931-8633810fc3f9' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-4b556a2e-1ca2-436c-b931-8633810fc3f9' class='xr-section-summary'  title='Expand/collapse section'>Coordinates: <span>(0)</span></label>
<div class="xr-section-inline-details">

</div>
<div class="xr-section-details">
<ul class="xr-var-list">
</ul>
</div>
</li>
<li class="xr-section-item">
<input id='section-5681b80f-e688-460c-ab2a-cbf11c693f97' class='xr-section-summary-in' type='checkbox'  checked><label for='section-5681b80f-e688-460c-ab2a-cbf11c693f97' class='xr-section-summary' >Data variables: <span>(12)</span></label>
<div class="xr-section-inline-details">

</div>
<div class="xr-section-details">
<ul class="xr-var-list">
<li class="xr-var-item">
<div class="xr-var-name">
<span>β</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.813
</div>
<input id='attrs-6d6ebe00-49bf-443c-a635-b2a085ae2a0c' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-6d6ebe00-49bf-443c-a635-b2a085ae2a0c' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-b7902a7e-8f84-490c-b48d-6b652ecb242f' class='xr-var-data-in' type='checkbox'><label for='data-b7902a7e-8f84-490c-b48d-6b652ecb242f' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.81270912)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>Δ_α</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.885
</div>
<input id='attrs-14d81b4e-c8a3-4084-8154-c90cd50d230a' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-14d81b4e-c8a3-4084-8154-c90cd50d230a' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-a238804e-9eba-4ccc-9f6c-54c0c7540b93' class='xr-var-data-in' type='checkbox'><label for='data-a238804e-9eba-4ccc-9f6c-54c0c7540b93' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.88526959)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>σ_α</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.814
</div>
<input id='attrs-195fd498-8c9c-4d5b-9b7e-450f7cd0a465' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-195fd498-8c9c-4d5b-9b7e-450f7cd0a465' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-074ae403-d66c-441b-9a07-36d9c5451b26' class='xr-var-data-in' type='checkbox'><label for='data-074ae403-d66c-441b-9a07-36d9c5451b26' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.81400238)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>Δ_ξ</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.86
</div>
<input id='attrs-087a0100-8205-4d19-93f0-394e5e9aa7c7' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-087a0100-8205-4d19-93f0-394e5e9aa7c7' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-dbd78f5e-f6c2-4d04-bbcb-03a0ad406ca8' class='xr-var-data-in' type='checkbox'><label for='data-dbd78f5e-f6c2-4d04-bbcb-03a0ad406ca8' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.85974353)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>σ_ξ</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.805
</div>
<input id='attrs-3f2853d8-a1ec-4b35-8849-2b13e039ecef' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-3f2853d8-a1ec-4b35-8849-2b13e039ecef' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-0b6449bf-95ee-4f49-b8cd-7b3ccd1b24fa' class='xr-var-data-in' type='checkbox'><label for='data-0b6449bf-95ee-4f49-b8cd-7b3ccd1b24fa' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.80451891)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>f_pos_row</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.727
</div>
<input id='attrs-461c5a4c-78e8-4a81-b1f7-8a8f1459af24' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-461c5a4c-78e8-4a81-b1f7-8a8f1459af24' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-eb90cc03-759c-4ae5-84a0-dd7679bc712c' class='xr-var-data-in' type='checkbox'><label for='data-eb90cc03-759c-4ae5-84a0-dd7679bc712c' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.72748944)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>f_block_unid</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.818
</div>
<input id='attrs-35db9239-4a34-43bc-9516-5d2abb077118' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-35db9239-4a34-43bc-9516-5d2abb077118' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-0ec0fec8-f669-456b-baaf-5a6ac8e2fc60' class='xr-var-data-in' type='checkbox'><label for='data-0ec0fec8-f669-456b-baaf-5a6ac8e2fc60' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.81831663)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>γ_unid</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.808
</div>
<input id='attrs-31481cfa-752c-4946-abe4-7210cc3eb712' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-31481cfa-752c-4946-abe4-7210cc3eb712' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-8085c1fb-d93f-4012-ba4c-3a90399dc14d' class='xr-var-data-in' type='checkbox'><label for='data-8085c1fb-d93f-4012-ba4c-3a90399dc14d' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.80812046)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>σ</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.832
</div>
<input id='attrs-4805568a-632a-495b-a327-231e773fef7a' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-4805568a-632a-495b-a327-231e773fef7a' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-ad27b52a-2f3e-460b-a569-c8118c21ea56' class='xr-var-data-in' type='checkbox'><label for='data-ad27b52a-2f3e-460b-a569-c8118c21ea56' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.83187637)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>obs_ctrl_missing</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.82
</div>
<input id='attrs-4ce94dc7-3656-4125-b540-e5d22a7b559b' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-4ce94dc7-3656-4125-b540-e5d22a7b559b' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-019a7263-5579-4097-9a0d-46865971b755' class='xr-var-data-in' type='checkbox'><label for='data-019a7263-5579-4097-9a0d-46865971b755' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.81951939)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>α</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.85
</div>
<input id='attrs-05963eaf-361d-4844-9489-f9bfca046c01' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-05963eaf-361d-4844-9489-f9bfca046c01' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-94ce3608-1248-4c6d-adc6-26c77a635f78' class='xr-var-data-in' type='checkbox'><label for='data-94ce3608-1248-4c6d-adc6-26c77a635f78' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.84973862)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>ξ</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.848
</div>
<input id='attrs-90ea0b58-91fe-48ff-be98-3d84f857cf5f' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-90ea0b58-91fe-48ff-be98-3d84f857cf5f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-81fb896b-5ccc-4b87-a983-76ab95199ef4' class='xr-var-data-in' type='checkbox'><label for='data-81fb896b-5ccc-4b87-a983-76ab95199ef4' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.84825114)</pre>
</div>
</li>
</ul>
</div>
</li>
<li class="xr-section-item">
<input id='section-a3ba7cb2-32d9-41a2-be53-1065b4780eeb' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-a3ba7cb2-32d9-41a2-be53-1065b4780eeb' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label>
<div class="xr-section-inline-details">

</div>
<div class="xr-section-details">
<dl class="xr-attrs">
</dl>
</div>
</li>
</ul>
</div>
</div>
<p>As expected, the <span class="math inline">\(\hat{R}\)</span> parameters are quite high, indiciating that the chains have not converged well. This behavior is expected, since we know that this model is reflection-invariant and therefore has a multimodal posterior.</p>
<p>As in the previous post on identification in factor analysis, we choose a row of <code>f_block_unid</code> that we constrain to have all positive entries and change the signs of the entries <code>f_block_unid</code> and <code>γ_unid</code> so that they have the same relationship with the signs of this row. We choose the row that has the chain whose latent factors have the largest posterior expected distance from the origin.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>block_mean <span class="op">=</span> (ref_trace.posterior[<span class="st">&quot;f_block_unid&quot;</span>]</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>                       .mean(dim<span class="op">=</span><span class="st">&quot;draw&quot;</span>))</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>block_mean_norm <span class="op">=</span> np.square(block_mean).<span class="bu">sum</span>(dim<span class="op">=</span><span class="st">&quot;fact&quot;</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>sign_row <span class="op">=</span> (block_mean_norm.<span class="bu">max</span>(dim<span class="op">=</span><span class="st">&quot;chain&quot;</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                           .argmax()</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                           .item())</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>sign_chain <span class="op">=</span> (block_mean_norm.sel({<span class="st">&quot;time_block&quot;</span>: sign_row})</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>                             .argmax()</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>                             .item())</span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>target_sign <span class="op">=</span> (np.sign(block_mean.sel({<span class="st">&quot;chain&quot;</span>: sign_chain,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;time_block&quot;</span>: sign_row}))</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                 .data)</span></code></pre></div>
<p>We can now specify the identified model, which is largely the same as the previous model.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>coords) <span class="im">as</span> model:</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    β <span class="op">=</span> pm.Normal(<span class="st">&quot;β&quot;</span>, <span class="fl">0.</span>, <span class="fl">5.</span>, dims<span class="op">=</span><span class="st">&quot;feat&quot;</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    α <span class="op">=</span> noncentered_normal(<span class="st">&quot;α&quot;</span>, (<span class="st">&quot;unit&quot;</span>, <span class="st">&quot;feat&quot;</span>), μ<span class="op">=</span><span class="fl">0.</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    ξ <span class="op">=</span> noncentered_normal(<span class="st">&quot;ξ&quot;</span>, (<span class="st">&quot;feat&quot;</span>, <span class="st">&quot;time&quot;</span>), μ<span class="op">=</span><span class="fl">0.</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    θ <span class="op">=</span> β[np.newaxis, :, np.newaxis] <span class="op">\</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span> α[..., np.newaxis] <span class="op">\</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span> ξ[np.newaxis, ...]</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    f_pos_row <span class="op">=</span> pm.HalfNormal(<span class="st">&quot;f_pos_row&quot;</span>, HALFNORMAL_SCALE,</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>                              dims<span class="op">=</span><span class="st">&quot;fact&quot;</span>)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    f_block_unid <span class="op">=</span> pm.Normal(<span class="st">&quot;f_block_unid&quot;</span>, <span class="fl">0.</span>, <span class="fl">1.</span>,</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>                             dims<span class="op">=</span>(<span class="st">&quot;time_block&quot;</span>, <span class="st">&quot;fact&quot;</span>))</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    γ_unid <span class="op">=</span> pm.Normal(<span class="st">&quot;γ_unid&quot;</span>, <span class="fl">0.</span>, <span class="fl">1.</span>, dims<span class="op">=</span>(<span class="st">&quot;unit&quot;</span>, <span class="st">&quot;fact&quot;</span>))</span></code></pre></div>
<p>We now enforce the sign constraints that will break the reflectional invariance of the previous model and specify the observational likelihood.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model:</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    unid_sign <span class="op">=</span> at.sgn(f_block_unid[sign_row])</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    f_block <span class="op">=</span> pm.Deterministic(</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;f_block&quot;</span>, target_sign <span class="op">*</span> unid_sign <span class="op">*</span> f_block_unid,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span>(<span class="st">&quot;time_block&quot;</span>, <span class="st">&quot;fact&quot;</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> at.concatenate((</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>        at.eye(N_factor),</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>        at.shape_padleft(f_pos_row),</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>        f_block</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    γ <span class="op">=</span> pm.Deterministic(</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;γ&quot;</span>, target_sign <span class="op">*</span> unid_sign <span class="op">*</span> γ_unid,</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span>(<span class="st">&quot;unit&quot;</span>, <span class="st">&quot;fact&quot;</span>)</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    μ_ctrl <span class="op">=</span> (X[..., np.newaxis] <span class="op">*</span> θ).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">+</span> γ.dot(f.T)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    σ <span class="op">=</span> pm.HalfNormal(<span class="st">&quot;σ&quot;</span>, <span class="fl">5.</span> <span class="op">*</span> HALFNORMAL_SCALE)</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    obs_ctrl <span class="op">=</span> pm.Normal(<span class="st">&quot;obs_ctrl&quot;</span>, μ_ctrl, σ, observed<span class="op">=</span>y_ctrl)</span></code></pre></div>
<p>We now sample from this identified model.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model:</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    trace <span class="op">=</span> pm.sample(<span class="op">**</span>SAMPLE_KWARGS)</span></code></pre></div>
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (3 chains in 3 jobs)
NUTS: [β, Δ_α, σ_α, Δ_ξ, σ_ξ, f_pos_row, f_block_unid, γ_unid, σ, obs_ctrl_missing]</code></pre>
<div>
<style>
/* Turns off some styling */
progress {
/* gets rid of default border in Firefox and Opera. */
border: none;
/* Needs to be in here for Safari polyfill so background images work as expected. */
background-size: auto;
}
.progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
background: #F44336;
}
</style>
<progress value="6000" class max="6000" style="width:300px; height:20px; vertical-align: middle;">
</progress>
<p>100.00% [6000/6000 13:54&lt;00:00 Sampling 3 chains, 0 divergences]</p>
</div>
<pre><code>Sampling 3 chains for 1_000 tune and 1_000 draw iterations (3_000 + 3_000 draws total) took 835 seconds.
The rhat statistic is larger than 1.4 for some parameters. The sampler did not converge.
The estimated number of effective samples is smaller than 200 for some parameters.</code></pre>
<p>For the moment we ignore the convergence warnings, because we expect the <span class="math inline">\(\hat{R}\)</span> values for <code>f_block_unid</code> and <code>γ_unid</code> to be high.</p>
<p>The energy plot shows no cause for concern.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>az.plot_energy(trace)<span class="op">;</span></span></code></pre></div>
<center>
<img src="/resources/basc-ccs_files/basc-ccs_82_0.png" title="fig:" alt="png" />
</center>
<p>Ignoring the variables we know are not identified, all of our <span class="math inline">\(\hat{R}\)</span> statistics are reasonable as well.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>rhat_var_names <span class="op">=</span> [</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    var_name <span class="cf">for</span> var_name <span class="kw">in</span> trace.posterior.data_vars</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> var_name.endswith(<span class="st">&quot;_unid&quot;</span>)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>az.rhat(trace, var_names<span class="op">=</span>rhat_var_names).<span class="bu">max</span>()</span></code></pre></div>
<div>
<svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs> <symbol id="icon-database" viewBox="0 0 32 32"> <path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path> <path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path> <path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path> </symbol> <symbol id="icon-file-text2" viewBox="0 0 32 32"> <path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path> <path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path> <path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path> <path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path> </symbol> </defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style>
<pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
Dimensions:           ()
Data variables:
    β                 float64 1.004
    Δ_α               float64 1.007
    σ_α               float64 1.003
    Δ_ξ               float64 1.008
    σ_ξ               float64 1.0
    f_pos_row         float64 1.002
    σ                 float64 1.002
    obs_ctrl_missing  float64 1.004
    α                 float64 1.008
    ξ                 float64 1.008
    f_block           float64 1.008
    γ                 float64 1.008</pre>
<div class="xr-wrap" hidden="">
<div class="xr-header">
<div class="xr-obj-type">
xarray.Dataset
</div>
</div>
<ul class="xr-sections">
<li class="xr-section-item">
<input id='section-e868ecab-ab46-4e76-a98f-831c5cf2cd71' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-e868ecab-ab46-4e76-a98f-831c5cf2cd71' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label>
<div class="xr-section-inline-details">

</div>
<div class="xr-section-details">

</div>
</li>
<li class="xr-section-item">
<input id='section-4ab2f128-0006-4117-842d-254234088f77' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-4ab2f128-0006-4117-842d-254234088f77' class='xr-section-summary'  title='Expand/collapse section'>Coordinates: <span>(0)</span></label>
<div class="xr-section-inline-details">

</div>
<div class="xr-section-details">
<ul class="xr-var-list">
</ul>
</div>
</li>
<li class="xr-section-item">
<input id='section-0bd793ab-7da3-4760-bf0f-da019de57876' class='xr-section-summary-in' type='checkbox'  checked><label for='section-0bd793ab-7da3-4760-bf0f-da019de57876' class='xr-section-summary' >Data variables: <span>(12)</span></label>
<div class="xr-section-inline-details">

</div>
<div class="xr-section-details">
<ul class="xr-var-list">
<li class="xr-var-item">
<div class="xr-var-name">
<span>β</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.004
</div>
<input id='attrs-6e7ef1f5-eb43-448c-9a1f-ad5b81a34d91' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-6e7ef1f5-eb43-448c-9a1f-ad5b81a34d91' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-0ba991ac-27ad-4144-b8f7-f4833d12433a' class='xr-var-data-in' type='checkbox'><label for='data-0ba991ac-27ad-4144-b8f7-f4833d12433a' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.00389839)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>Δ_α</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.007
</div>
<input id='attrs-aae261c1-c9b1-4b78-814b-f8da914c5da9' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-aae261c1-c9b1-4b78-814b-f8da914c5da9' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-1b1b9bed-c79b-4ed9-aa8a-2c7e75168d2a' class='xr-var-data-in' type='checkbox'><label for='data-1b1b9bed-c79b-4ed9-aa8a-2c7e75168d2a' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.00650723)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>σ_α</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.003
</div>
<input id='attrs-9773e5fb-4b47-4af4-8f63-fe06d1cd9c73' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-9773e5fb-4b47-4af4-8f63-fe06d1cd9c73' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-ea53a995-6661-4f43-a045-718e964805e2' class='xr-var-data-in' type='checkbox'><label for='data-ea53a995-6661-4f43-a045-718e964805e2' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.00252306)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>Δ_ξ</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.008
</div>
<input id='attrs-c688aa01-9a10-4dc1-a609-ffae2e13a410' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-c688aa01-9a10-4dc1-a609-ffae2e13a410' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-bd5436f3-c0ea-43bb-a6f8-7268618e7669' class='xr-var-data-in' type='checkbox'><label for='data-bd5436f3-c0ea-43bb-a6f8-7268618e7669' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.00802131)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>σ_ξ</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.0
</div>
<input id='attrs-c9c1f02c-e799-4ce3-b3f4-43c7b01a97c3' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-c9c1f02c-e799-4ce3-b3f4-43c7b01a97c3' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-514a6c0a-a62e-4570-9e5a-ca360d5a4e53' class='xr-var-data-in' type='checkbox'><label for='data-514a6c0a-a62e-4570-9e5a-ca360d5a4e53' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.00025354)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>f_pos_row</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.002
</div>
<input id='attrs-738f9bb1-e429-4f71-a4f6-b6498f534dba' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-738f9bb1-e429-4f71-a4f6-b6498f534dba' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-687b4df4-2860-497b-b822-cf16021375e9' class='xr-var-data-in' type='checkbox'><label for='data-687b4df4-2860-497b-b822-cf16021375e9' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.00226488)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>σ</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.002
</div>
<input id='attrs-ae4dafa7-0c54-4f76-a439-1cd72f7e769a' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-ae4dafa7-0c54-4f76-a439-1cd72f7e769a' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-4cafa54f-26f7-4b24-8583-d6acfdfad636' class='xr-var-data-in' type='checkbox'><label for='data-4cafa54f-26f7-4b24-8583-d6acfdfad636' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.00224675)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>obs_ctrl_missing</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.004
</div>
<input id='attrs-ba2a3547-d323-470b-b356-0560808a2fd5' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-ba2a3547-d323-470b-b356-0560808a2fd5' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d761dea0-cbbb-42bd-8cd5-5e233a9ec002' class='xr-var-data-in' type='checkbox'><label for='data-d761dea0-cbbb-42bd-8cd5-5e233a9ec002' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.00359828)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>α</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.008
</div>
<input id='attrs-e8acbada-6dd8-48f6-86d5-d81ab8c0288e' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-e8acbada-6dd8-48f6-86d5-d81ab8c0288e' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-168184b4-e590-41b9-8bf8-09ce70703b46' class='xr-var-data-in' type='checkbox'><label for='data-168184b4-e590-41b9-8bf8-09ce70703b46' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.00811494)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>ξ</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.008
</div>
<input id='attrs-1c594262-ea32-4fac-a015-0a50b9ef2170' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-1c594262-ea32-4fac-a015-0a50b9ef2170' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-00cecafb-deaf-4b32-ac9c-68fd849bf458' class='xr-var-data-in' type='checkbox'><label for='data-00cecafb-deaf-4b32-ac9c-68fd849bf458' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.00801751)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>f_block</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.008
</div>
<input id='attrs-3cbf5457-d609-4282-b5f6-b52ddc298a6a' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-3cbf5457-d609-4282-b5f6-b52ddc298a6a' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-8f0764b8-3a9a-452a-8eec-660c7b2a9443' class='xr-var-data-in' type='checkbox'><label for='data-8f0764b8-3a9a-452a-8eec-660c7b2a9443' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.00819455)</pre>
</div>
</li>
<li class="xr-var-item">
<div class="xr-var-name">
<span>γ</span>
</div>
<div class="xr-var-dims">
()
</div>
<div class="xr-var-dtype">
float64
</div>
<div class="xr-var-preview xr-preview">
1.008
</div>
<input id='attrs-d3637a67-db84-4b64-b706-dda4099ffc67' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-d3637a67-db84-4b64-b706-dda4099ffc67' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-a5b3d3b1-e7dd-41e9-a066-b42db0e2a917' class='xr-var-data-in' type='checkbox'><label for='data-a5b3d3b1-e7dd-41e9-a066-b42db0e2a917' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-var-attrs">
<dl class="xr-attrs">
</dl>
</div>
<div class="xr-var-data">
<pre>array(1.00805011)</pre>
</div>
</li>
</ul>
</div>
</li>
<li class="xr-section-item">
<input id='section-3de1dac7-3cc2-46ee-8336-d342466c70aa' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-3de1dac7-3cc2-46ee-8336-d342466c70aa' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label>
<div class="xr-section-inline-details">

</div>
<div class="xr-section-details">
<dl class="xr-attrs">
</dl>
</div>
</li>
</ul>
</div>
</div>
<p>The model has recovered the true regression coefficients reasonably well.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>ax, <span class="op">=</span> az.plot_forest(trace, var_names<span class="op">=</span>[<span class="st">&quot;β&quot;</span>],</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>                     combined<span class="op">=</span><span class="va">True</span>, hdi_prob<span class="op">=</span><span class="fl">0.95</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>ax.scatter(B[::<span class="op">-</span><span class="dv">1</span>], ax.get_yticks(),</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>           c<span class="op">=</span><span class="st">&#39;k&#39;</span>, zorder<span class="op">=</span><span class="dv">5</span>, label<span class="op">=</span><span class="st">&quot;Actual&quot;</span>)<span class="op">;</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels([])<span class="op">;</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r&quot;$\beta_j$&quot;</span>)<span class="op">;</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">&#39;upper left&#39;</span>)<span class="op">;</span></span></code></pre></div>
<center>
<img src="/resources/basc-ccs_files/basc-ccs_87_0.png" title="fig:" alt="png" />
</center>
<p>We now turn to estimating the causal effect. First we build an array of the posterior imputed control outcomes for the treated units.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>post_treat_ctrl <span class="op">=</span> xr.DataArray(</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    trace.posterior[<span class="st">&quot;obs_ctrl_missing&quot;</span>]</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>          .data</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>          .reshape((CORES, <span class="dv">1000</span>, n_treated, T <span class="op">-</span> T_treat)),</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    dims<span class="op">=</span>(</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;chain&quot;</span>, <span class="st">&quot;draw&quot;</span>,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;treat_unit&quot;</span>, <span class="st">&quot;treat_time&quot;</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>post_treat_ctrl.head()</span></code></pre></div>
<div>
<svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs> <symbol id="icon-database" viewBox="0 0 32 32"> <path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path> <path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path> <path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path> </symbol> <symbol id="icon-file-text2" viewBox="0 0 32 32"> <path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path> <path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path> <path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path> <path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path> </symbol> </defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style>
<pre class='xr-text-repr-fallback'>&lt;xarray.DataArray (chain: 3, draw: 5, treat_unit: 5, treat_time: 5)&gt;
array([[[[ 1.25759892e+01,  1.30612264e+01,  1.57087369e+01,
           1.49536257e+01,  1.64677110e+01],
         [-4.12810485e-02,  6.26047750e+00,  7.79874263e+00,
           1.23859034e+01,  1.61490831e+01],
         [ 7.27955473e+00,  1.04034349e+01,  1.12521199e+01,
           1.11063292e+01,  1.13530200e+01],
         [-5.36650155e+00, -5.83322477e+00, -3.35144524e+00,
           3.44000735e+00,  1.88207349e+00],
         [-1.31260800e+01, -1.22691019e+01, -1.33695535e+01,
          -5.94977044e+00, -8.61557509e+00]],

        [[ 1.30278045e+01,  1.42052058e+01,  1.40630688e+01,
           1.47218969e+01,  1.93233792e+01],
         [ 2.45746861e+00,  3.67240422e+00,  6.87289651e+00,
           8.61550996e+00,  1.48857372e+01],
         [ 8.68996670e+00,  1.22336995e+01,  1.01608424e+01,
           9.78275733e+00,  1.42336802e+01],
         [-6.32208820e+00, -3.22852886e+00, -1.89722169e+00,
           3.30217994e-01,  3.78225547e+00],
         [-1.53244972e+01, -1.35265466e+01, -1.36205170e+01,
...
           1.35873648e+01,  1.50553915e+01],
         [ 3.01241871e+00,  5.42217922e+00,  6.50204080e+00,
           1.15586759e+01,  1.33643026e+01],
         [ 7.65560768e+00,  1.29871011e+01,  9.75434111e+00,
           1.09479191e+01,  1.26587440e+01],
         [-3.59855020e+00, -4.76761066e+00, -4.10285725e+00,
           2.14369279e+00,  3.28661610e-01],
         [-1.39193859e+01, -1.79066255e+01, -1.26329862e+01,
          -4.73557646e+00, -7.94774028e+00]],

        [[ 1.38132791e+01,  1.24831973e+01,  1.20970456e+01,
           1.37274249e+01,  1.51289416e+01],
         [ 3.95173624e+00,  5.69156061e+00,  6.21128104e+00,
           1.20260114e+01,  1.34918240e+01],
         [ 7.22084256e+00,  1.30855164e+01,  9.73445859e+00,
           1.10445040e+01,  1.27090074e+01],
         [-3.85094179e+00, -3.93828746e+00, -3.88376440e+00,
           1.53955903e+00,  8.58625045e-01],
         [-1.39993793e+01, -1.79798655e+01, -1.25980525e+01,
          -4.70834640e+00, -7.87338772e+00]]]])
Dimensions without coordinates: chain, draw, treat_unit, treat_time</pre>
<div class="xr-wrap" hidden="">
<div class="xr-header">
<div class="xr-obj-type">
xarray.DataArray
</div>
<div class="xr-array-name">

</div>
<ul class="xr-dim-list">
<li>
<span>chain</span>: 3
</li>
<li>
<span>draw</span>: 5
</li>
<li>
<span>treat_unit</span>: 5
</li>
<li>
<span>treat_time</span>: 5
</li>
</ul>
</div>
<ul class="xr-sections">
<li class="xr-section-item">
<div class="xr-array-wrap">
<input id='section-d7c9a0fd-edfc-4da3-90ab-fc328b4dec2d' class='xr-array-in' type='checkbox' checked><label for='section-d7c9a0fd-edfc-4da3-90ab-fc328b4dec2d' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label>
<div class="xr-array-preview xr-preview">
<span>12.58 13.06 15.71 14.95 16.47 … -14.0 -17.98 -12.6 -4.708 -7.873</span>
</div>
<div class="xr-array-data">
<pre>array([[[[ 1.25759892e+01,  1.30612264e+01,  1.57087369e+01,
           1.49536257e+01,  1.64677110e+01],
         [-4.12810485e-02,  6.26047750e+00,  7.79874263e+00,
           1.23859034e+01,  1.61490831e+01],
         [ 7.27955473e+00,  1.04034349e+01,  1.12521199e+01,
           1.11063292e+01,  1.13530200e+01],
         [-5.36650155e+00, -5.83322477e+00, -3.35144524e+00,
           3.44000735e+00,  1.88207349e+00],
         [-1.31260800e+01, -1.22691019e+01, -1.33695535e+01,
          -5.94977044e+00, -8.61557509e+00]],

        [[ 1.30278045e+01,  1.42052058e+01,  1.40630688e+01,
           1.47218969e+01,  1.93233792e+01],
         [ 2.45746861e+00,  3.67240422e+00,  6.87289651e+00,
           8.61550996e+00,  1.48857372e+01],
         [ 8.68996670e+00,  1.22336995e+01,  1.01608424e+01,
           9.78275733e+00,  1.42336802e+01],
         [-6.32208820e+00, -3.22852886e+00, -1.89722169e+00,
           3.30217994e-01,  3.78225547e+00],
         [-1.53244972e+01, -1.35265466e+01, -1.36205170e+01,
...
           1.35873648e+01,  1.50553915e+01],
         [ 3.01241871e+00,  5.42217922e+00,  6.50204080e+00,
           1.15586759e+01,  1.33643026e+01],
         [ 7.65560768e+00,  1.29871011e+01,  9.75434111e+00,
           1.09479191e+01,  1.26587440e+01],
         [-3.59855020e+00, -4.76761066e+00, -4.10285725e+00,
           2.14369279e+00,  3.28661610e-01],
         [-1.39193859e+01, -1.79066255e+01, -1.26329862e+01,
          -4.73557646e+00, -7.94774028e+00]],

        [[ 1.38132791e+01,  1.24831973e+01,  1.20970456e+01,
           1.37274249e+01,  1.51289416e+01],
         [ 3.95173624e+00,  5.69156061e+00,  6.21128104e+00,
           1.20260114e+01,  1.34918240e+01],
         [ 7.22084256e+00,  1.30855164e+01,  9.73445859e+00,
           1.10445040e+01,  1.27090074e+01],
         [-3.85094179e+00, -3.93828746e+00, -3.88376440e+00,
           1.53955903e+00,  8.58625045e-01],
         [-1.39993793e+01, -1.79798655e+01, -1.25980525e+01,
          -4.70834640e+00, -7.87338772e+00]]]])</pre>
</div>
</div>
</li>
<li class="xr-section-item">
<input id='section-921babcf-a899-4c07-ac3a-e3a0aab640ba' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-921babcf-a899-4c07-ac3a-e3a0aab640ba' class='xr-section-summary'  title='Expand/collapse section'>Coordinates: <span>(0)</span></label>
<div class="xr-section-inline-details">

</div>
<div class="xr-section-details">
<ul class="xr-var-list">
</ul>
</div>
</li>
<li class="xr-section-item">
<input id='section-7a1bc9f5-7da1-4979-ab63-380b8469bae6' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-7a1bc9f5-7da1-4979-ab63-380b8469bae6' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label>
<div class="xr-section-inline-details">

</div>
<div class="xr-section-details">
<dl class="xr-attrs">
</dl>
</div>
</li>
</ul>
</div>
</div>
<p>We plot these against the observed treated values to visualize the treatment effect.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>treated_c <span class="op">=</span> [<span class="ss">f&quot;C</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&quot;</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_treated)]</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>ax.plot(post_treat_ctrl.mean(dim<span class="op">=</span>(<span class="st">&quot;chain&quot;</span>, <span class="st">&quot;draw&quot;</span>)).T,</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>        ls<span class="op">=</span><span class="st">&#39;--&#39;</span>)<span class="op">;</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>ax.set_prop_cycle(<span class="va">None</span>)<span class="op">;</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>ax.plot(y[treated, T_treat:].T)<span class="op">;</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="vs">r&quot;$t - T_{\mathrm</span><span class="sc">{treated}</span><span class="vs">}$&quot;</span>)<span class="op">;</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">&quot;y_{i, t}&quot;</span>)<span class="op">;</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>handles <span class="op">=</span> [</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], c<span class="op">=</span><span class="st">&#39;k&#39;</span>,</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>           label<span class="op">=</span><span class="st">&quot;Treated (observed)&quot;</span>),</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], c<span class="op">=</span><span class="st">&#39;k&#39;</span>, ls<span class="op">=</span><span class="st">&#39;--&#39;</span>,</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>           label<span class="op">=</span><span class="st">&quot;Control (posterior expected value)&quot;</span>)</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">&#39;upper left&#39;</span>, handles<span class="op">=</span>handles)<span class="op">;</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">&quot;Treated units&quot;</span>)<span class="op">;</span></span></code></pre></div>
<center>
<img src="/resources/basc-ccs_files/basc-ccs_92_0.png" title="fig:" alt="png" />
</center>
<p>Here we see that the posterior estimates of the treatment effect are quite close to the actual effect.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>low, high <span class="op">=</span> (</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    (y[treated, T_treat:] <span class="op">-</span> post_treat_ctrl)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>        .quantile([<span class="fl">0.025</span>, <span class="fl">0.975</span>],</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>                  dim<span class="op">=</span>(<span class="st">&quot;chain&quot;</span>, <span class="st">&quot;draw&quot;</span>, <span class="st">&quot;treat_unit&quot;</span>))</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>ax.fill_between(np.arange(T <span class="op">-</span> T_treat), low, high,</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">&#39;C0&#39;</span>, alpha<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">&quot;95</span><span class="sc">% c</span><span class="st">redible interval&quot;</span>)<span class="op">;</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>ax.plot([<span class="dv">0</span>, T <span class="op">-</span> T_treat <span class="op">-</span> <span class="dv">1</span>], [<span class="dv">0</span>, T <span class="op">-</span> T_treat <span class="op">-</span> <span class="dv">1</span>], </span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">&#39;k&#39;</span>, label<span class="op">=</span><span class="st">&quot;Actual&quot;</span>)<span class="op">;</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>ax.plot(</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>    y[treated, T_treat:].T <span class="op">\</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> post_treat_ctrl.mean(dim<span class="op">=</span>(<span class="st">&quot;chain&quot;</span>, <span class="st">&quot;draw&quot;</span>)).T,</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    c<span class="op">=</span><span class="st">&#39;C0&#39;</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>handles, _ <span class="op">=</span> ax.get_legend_handles_labels()</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>handles.insert(</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, Line2D([<span class="dv">0</span>], [<span class="dv">0</span>],c<span class="op">=</span><span class="st">&#39;C0&#39;</span>, label<span class="op">=</span><span class="st">&quot;Posterior expected&quot;</span>)</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">&#39;upper left&#39;</span>, handles<span class="op">=</span>handles)<span class="op">;</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="vs">r&quot;$t - T_{\mathrm</span><span class="sc">{treated}</span><span class="vs">}$&quot;</span>)<span class="op">;</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">&quot;Treatment effect&quot;</span>)<span class="op">;</span></span></code></pre></div>
<center>
<img src="/resources/basc-ccs_files/basc-ccs_94_0.png" title="fig:" alt="png" />
</center>
<p>This post is available as a Jupyter notebook <a href="https://nbviewer.jupyter.org/gist/AustinRochford/932fa17bbd2d9b40c6efacdd4fcafa5a">here</a>.</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>Pang, Xun, Licheng Liu, and Yiqing Xu. “A Bayesian alternative to synthetic control for comparative case studies.” <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3649226#"><em>Available at SSRN</em></a> (2020).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>Murphy, Kevin P. <em>Machine learning: a probabilistic perspective.</em> MIT press, 2012.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
